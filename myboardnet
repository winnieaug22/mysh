#!/bin/bash

# Define the file path to modify
# FILE="/etc/network/interfaces"
FILE="myboardnetdir/interfaces"
sysintf="/etc/network/interfaces"
rootdir="/home/root"

# Check if parameter is provided
if [ -z "$1" ]; then
    echo "Usage: $0 <address|dhcp>"
    echo "Example addresses: 140.96.28.6, 140.96.28.7, 192.168.0.6, 192.168.0.7, dhcp"
    echo "-------"
    echo "./myboardnet 140.96.28.6"
    echo "cat $FILE"
    echo "mv $sysintf ${sysintf}_ori"
    echo "cp $FILE $sysintf"
    echo "/etc/init.d/networking restart"
    echo "-------"
    echo "chmod 777 myboardnetdir/myboardssh"
    echo "./myboardnetdir/myboardssh"
    echo "-------"
    echo "cp myboardnetdir/bashrc ~/.bashrc"
    echo "source ~/.bashrc"
    echo "-------"
    exit 1
fi
# Check if eth0 configuration exists
if ! grep -q 'iface eth0 inet dhcp' "$FILE"; then
    echo "Error: No configuration found for eth0."
    exit 1
fi

if [ "$1" == "dhcp" ]; then
    # Uncomment the dhcp configuration and remove static configuration
    if grep -q '^#iface eth0 inet dhcp' "$FILE"; then
        # Uncomment the line
        sed -i 's/^#iface eth0 inet dhcp/iface eth0 inet dhcp/' "$FILE"
    fi
    # Remove any existing static configuration
    sed -i '/^iface eth0 inet static/,/^$/d' "$FILE"
    echo "Switched to DHCP configuration."
else
    # Extract the first three octets of the address for network and gateway
    network=$(echo "$1" | awk -F. '{print $1"."$2"."$3".0"}')
    gateway=$(echo "$1" | awk -F. '{print $1"."$2"."$3".1"}')

    # New configuration to replace the old one
    NEW_CONFIG="iface eth0 inet static
        address $1
        netmask 255.255.255.0
        network $network
        gateway $gateway"

    # Comment out the dhcp configuration if exists
    if grep -q '^iface eth0 inet dhcp' "$FILE"; then
        sed -i 's/^iface eth0 inet dhcp/#iface eth0 inet dhcp/' "$FILE"
    fi

    # Check if static configuration already exists and update
    if grep -q '^iface eth0 inet static' "$FILE"; then
        # Replace existing static configuration
        sed -i '/^iface eth0 inet static/,/^$/c\\'$NEW_CONFIG "$FILE"
        echo "Address configuration updated to: $1"
    else
        # Append new static configuration
        echo "$NEW_CONFIG" >> "$FILE"
        echo "Address configuration set to: $1"
    fi
fi
